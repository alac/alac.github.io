<html>
	<head>
		<meta http-equiv='Content-Type' content='text/html; charset=UTF-8'>
 	<title>  comparing patterns |  Aimless Bitshift</title>
 		<link rel='stylesheet' type='text/css' href='/assets/wvs.css'>
 		<link rel='stylesheet' type='text/css' href='/assets/normalize.css' />
	</head>
	<body>
		<div class='container'>
			<div class='headerbar'>
				<a href="/" style="text-decoration:none">
					<span style="color:#366B8F">
						aimless 
						<span style="color:white">bit</span>shift 
					</span>
				</a>
				<span class='headerbarMenu'>
					blog | notes | creations
				</span>
			</div>
			<div class='subcontainer'>
				<div class='headerbarSpacer'></div>
				<div class='header depthOneContent'>
						<div class="sideBarTitle">
							<h3>Recent:</h3>
						</div>
					
			  			<div class="menuCategoryPost">
					    	<a href="/objective-c/2016/04/04/objective_c_patterns.html">* comparing patterns</a>
						</div>
					
			  			<div class="menuCategoryPost">
					    	<a href="/tools/2015/05/23/source-control-gitting-started.html">* git / source control</a>
						</div>
					
				</div>
				<div class='sidebar depthOneContent'>
<!-- 					display recent posts by categories                           -->
						<div class="sideBarTitle">
							<h3>Recent:</h3>
						</div>
						
				  			<div class="menuCategoryPost">
						    	<a href="/objective-c/2016/04/04/objective_c_patterns.html">* comparing patterns</a>
							</div>
						
				  			<div class="menuCategoryPost">
						    	<a href="/tools/2015/05/23/source-control-gitting-started.html">* git / source control</a>
							</div>
						
						<br>
<!-- 					display all posts by categories                           -->
	
					<div class="menuCategory">
						<div class="menuCategoryTitle">
							<a name="tools">tools</a>
						</div>

						
						  	
						  								  		
						  	
						
						  	
						  		
						  			<div class="menuCategoryPost">
							    	<a href="/tools/2015/05/23/source-control-gitting-started.html">* git / source control</a>
									</div>
						  								  		
						  	
						
    				</div>
	
					<div class="menuCategory">
						<div class="menuCategoryTitle">
							<a name="objective-c">objective-c</a>
						</div>

						
						  	
						  								  		
						  	
						
						  	
						  		
						  			<div class="menuCategoryPost">
							    	<a href="/objective-c/2016/04/04/objective_c_patterns.html">* comparing patterns</a>
									</div>
						  								  		
						  	
						
    				</div>
	
				</div>
				<div class='content'>
				  <div class='post depthOneContent'>
	<div class='postHeader'>
	<h1>
		objective-c: comparing patterns
	</h1>
	</div>
	<div class='postBody'>
	04 Apr 2016 | objective-c
	<pre><code>         ^
         | D
Verbose  |
         |              N
         |              B
         |
         |                              K
Subtle   -------------------------------------&gt;

D = Delegate patterns
B = Block patterns
N = Notifications
K = Key Value Observation
</code></pre>

<p>Principle forms of interactions in Objective-C are delegate relationships, setting callback blocks, the notification system, and the observer pattern.</p>

<p>You can find real explanations of what they are in <a href="http://nshipster.com/key-value-observing/">short here</a> and in <a href="https://www.objc.io/issues/7-foundation/communication-patterns/#delegation">long here</a>.</p>

<p>This post will - in an effort to be useful - demonstrate <em>misuses</em> and potential <em>problems</em>.</p>

<!---
<!–end_preview–>
-->

<h2 id="trade-offs">Trade-Offs</h2>
<p>For any of these patterns, you can expect that they’ll vary in the following ways:</p>

<ul>
  <li>Boiler plate code (‘verbose’), making your final implementation noisy.</li>
  <li>Tendency to bizarre interactions (‘subtle’), leading to tough debugging down the line.</li>
  <li>Awkwardness of memory-management and cleanup.</li>
  <li>Ability to abuse them.</li>
</ul>

<h2 id="key-value-observing">Key Value Observing</h2>
<p>If you’re completely green to KVO, go ahead and read <a href="http://nshipster.com/key-value-observing/">this</a> to get a sense of it.</p>

<p>The ideal case for KVO is one of simple systems where each layer only needs to read data from the one below it.</p>

<p>Imagine a view KVO-ing the properties of a model for updates. Or, <a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93viewmodel">MVVM</a>.</p>

<p>But with how lightweight KVO is, it can be appealing to use it within a system as well. There’s two problems with this:</p>

<ul>
  <li>
    <p>EZ infinite loops.</p>
  </li>
  <li>
    <p>Suddenly, the timing of setting a property becomes very <em>intentional</em>.</p>

    <p>Setting it too early might trigger a KVO that changes <em>the assumptions of the rest of the current function call</em>.</p>

    <p><em>Or</em>  it gets set too early and the KVO gets triggered <em>before some state change completes</em>, leading to the KVO callback’s behavior being incorrect.</p>
  </li>
  <li>
    <p>It can <em>create a reliance on</em> implicit assumptions.</p>

    <p>Ex: 1</p>

    <p>Suppose you have an object <code>Thing</code> with a property <code>Stuff</code> and that <code>Stuff</code> has a property <code>Junk</code>.</p>

    <p>You know that <code>Stuff</code> is readonly, so it’s safe for a consumer of <code>Thing</code> to KVO <code>Stuff</code>’s <code>Junk</code>.</p>

    <p>You commit, then a co-worker decides to make <code>Stuff</code> readwrite. Now your code has <em>subtly</em> broken.</p>

    <p>Ex: 2</p>

    <p>You’re inserting a new feature into a pre-existing system. There are two relevant pre-existing components <code>A</code> and <code>B</code>.</p>

    <p>You need a callback to occur at a particular time. This happens to be when <code>A</code> and <code>B</code> are in a specific state. You KVO the relevant properties to check the states of <code>A</code> and <code>B</code>.</p>

    <p>You commit, then a co-worker changes implementation of <code>B</code>. <em>Your co-worker can’t tell that the specific timing of <code>B</code>’s state changes are important to you</em>, and now your code has <em>subtly</em> broken.</p>
  </li>
</ul>

<h2 id="kvo-takeaway">KVO Takeaway</h2>
<p>KVO allows you to write loosy coupled code by enabling the dependency to be one-way. However, it also allows you to write <em>implicitly</em> tightly coupled code.</p>

<p>Situationally, KVO may also be slow. Luckily, unabusive use of it is inheriently sparse and shouldn’t result in performance issues.</p>

<p>The default implementation of KVO is <a href="http://khanlou.com/2013/12/kvo-considered-harmful/">not popular</a>; it has a fugly api, and some weird lifecycle behaviors.</p>

<p>Notable alternative implementations:</p>

<ul>
  <li>
    <p>Facebook’s <a href="https://github.com/facebook/KVOController">KVOController</a></p>
  </li>
  <li>
    <p>Mike Ash’s <a href="https://github.com/mikeash/MAKVONotificationCenter">MAKAVO</a>.</p>
  </li>
</ul>

<h2 id="delegate-patterns">Delegate Patterns</h2>
<p>The delegate pattern takes issue with subtlety and <em>does away with it entirely</em>.</p>

<p>The message sender has a reference to a delegate object that it knows conforms to a particular protocol and it calls those methods as needed.</p>

<p>This works well for hiding the sender from the delegate and separating out the necessary details of the delegate from the rest of it’s implementation.</p>

<p>So, where does it go wrong?</p>

<ul>
  <li>
    <p>The delegate pattern doesn’t make sense in situations where the objects are <em>by definition tightly coupled</em> and therefore don’t need the flexibility. Instead it obfusicates an otherwise straightforward relationship.</p>

    <p>The easy example is a class that does a large scale computation, with enough steps to warrent being split into other objects. Since a step is inheriently an implementation detail of the computation, defining that relationship as a delegate relationship is unlikely to have any value.</p>
  </li>
  <li>
    <p>It doesn’t scale well to multiple delegates.</p>

    <p>For simulatenous delegates, you’ll need to add some sort of boilerplate to track them (likely, a weak collection). The upside here, compared to other patterns, is that you’ll be able to do things like have a priority system for when the updates occur.</p>

    <p>For multiple kinds of delegates, you’ll likely have a lot of <em>optional protocol methods</em> or a lot of empty implementations in the delegate classes.</p>
  </li>
  <li>
    <p>Ownership relationships and delegates.</p>

    <p>In general, the delegate should be kept around via a <code>weak</code> (or <code>assign</code>) reference rather than a <code>strong</code> reference to prevent retain cycles.</p>

    <p>Stick to this since <em>happening to know</em> that delegates aren’t retained elsewhere is a <em>subtle</em> implementation detail.</p>

    <p>If the delegates aren’t retained elsewhere, then at the very least the class that hooks them up is likely an <em>okay</em> (read: less bad) place to retain them.</p>
  </li>
</ul>

<h2 id="block-patterns">Block Patterns</h2>

<p>upsides:
* places the callback code close to the invocation.
* allows for arbitrary dependencies via block retains.
* easily return share/values with __block type local variables.</p>

<p>downsides:
* retain cycles.
* subtle retains (<em>ivars, _any</em> reference to a variable)
* possible to screw up by not checking that the block exists before calling it
* very subtle that the block object retains things, bad if the block is deallocated while running it
* block syntax is incredibly confusing.</p>

<h2 id="notifications">Notifications</h2>

<ul>
  <li>unregister or crash</li>
  <li>untyped payload</li>
</ul>

<h2 id="further-reading">Further Reading</h2>
<p>In addition to the references inline, <a href="http://nshipster.com/nsnotification-and-nsnotificationcenter/">this article on NSNotificationCenter</a> has a sweet chart about audience vs coupling of these patterns.</p>

	</div>
</div>
				</div>
			</div>
		</div>
	</body>
<html>